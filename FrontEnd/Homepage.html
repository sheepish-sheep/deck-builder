<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Load Supabase JS library directly -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4"></script>
    <style>
        /* Hide scrollbars but keep scrolling functionality */
        html, body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            display: none;
        }
        
        body {
            background-color: #0f172a;
            color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        
        .table-container {
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 0 30px rgba(17, 24, 39, 0.7);
        }
        
        .btn-glow {
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        .btn-glow::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: rotate(30deg);
            transition: transform 0.5s;
            z-index: -1;
        }
        
        .btn-glow:hover::after {
            transform: translateX(100%) rotate(30deg);
        }
        
        .page-title {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .float-animation {
            animation: float 5s ease-in-out infinite;
        }
        
    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">
    <!-- Background effects -->
        <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-24 -right-24 w-96 h-96 bg-blue-700 opacity-20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-96 h-96 bg-indigo-700 opacity-20 rounded-full blur-3xl"></div>
            <div class="absolute top-1/3 left-1/4 w-64 h-64 bg-cyan-700 opacity-10 rounded-full blur-2xl"></div>
        </div>
        
        <!-- Header Section - Fixed at top -->
        <header class="sticky top-0 w-full bg-slate-900/80 backdrop-blur-md border-b border-blue-500/30 shadow-lg shadow-blue-500/10 z-20 py-4 px-6">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold text-blue-400 page-title flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    My Decks
                </h1>
                <div class="flex items-center">
                    <span id="user-email" class="text-white mr-4 hidden md:inline"></span>
                    <button id="owned-cards-btn" class="flex items-center btn-glow bg-yellow-400/90 hover:bg-yellow-300 text-slate-900 font-semibold py-2 px-4 rounded mr-2 transition-all shadow">
                        <svg class="w-5 h-5 mr-1 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.175c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.922-.755 1.688-1.54 1.118l-3.38-2.454a1 1 0 00-1.175 0l-3.38 2.454c-.784.57-1.838-.196-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.05 9.394c-.783-.57-.38-1.81.588-1.81h4.175a1 1 0 00.95-.69l1.286-3.967z"/></svg>
                        Owned Cards
                    </button>
                    <button id="new-deck-btn" class="btn-glow bg-blue-600 text-white py-2 px-4 rounded mr-2">New Deck</button>
                    <button id="sign-out-btn" class="bg-red-500 text-white py-2 px-4 rounded">Sign Out</button>
                </div>
            </div>
        </header>
        

        <!-- Main content -->
        <main class="container mx-auto px-4 py-8 mt-16">
            <!-- Deck Container Box -->
            <div class="bg-slate-800/80 backdrop-blur-md rounded-xl border border-blue-500/30 shadow-lg shadow-blue-500/10 p-6 mb-6">
                <h2 class="text-xl font-semibold text-blue-300 mb-4 border-b border-blue-500/30 pb-2">Your Deck Collection</h2>
                <div id="decks-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Decks will be dynamically added here -->
                    <div class="deck-placeholder backdrop-blur-md bg-slate-900/40 border border-blue-500/10 rounded-lg p-4 flex items-center justify-center h-32">
                        <p class="text-blue-300/50 text-center">Loading your decks...</p>
                    </div>
                </div>
            </div>
        </main>
<script type="module">
import { getCurrentUser, signOut, ensureOwnedCardsDeck } from './js/auth.js';
import { getUserDecks, createDeck } from './js/deck-manager.js';

// Declare these as global functions since we're loading Supabase globally
let userDecks = [];

// On page load
document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM loaded, initializing app...');
    
    try {
        // Verify we have Supabase loaded
        if (!window.supabase) {
            console.error('Supabase not loaded!');
            alert('Error loading required libraries. Please refresh the page.');
            return;
        }
        
        // Check user session
        const user = await getCurrentUser();
        if (!user) {
            // redirect to login
            console.log('No user found, redirecting to login');
            window.location.href = '/Login.html';
            return;
        } else {
            await ensureOwnedCardsDeck(); // <-- call it here!
        }
        
        console.log('User authenticated:', user.email);
        document.getElementById('user-email').textContent = user.email;
        
        // Add event listeners
        document.getElementById('new-deck-btn').addEventListener('click', createNewDeck);
        document.getElementById('owned-cards-btn').addEventListener('click', loadOwnedCards);
        document.getElementById('sign-out-btn').addEventListener('click', async () => {
            await signOut();
            window.location.href = '/Login.html';
        });
        
        // Load decks
        await loadUserDecks();
    } catch (error) {
        console.error('Error initializing app:', error);
        alert('An error occurred while loading the application. See console for details.');
    }
});

async function loadUserDecks() {
    console.log('Loading user decks...');
    const decksContainer = document.getElementById('decks-container');
    decksContainer.innerHTML = '<div class="text-center"><p class="text-blue-300/50">Loading your decks...</p></div>';
    
    try {
        const result = await getUserDecks();
        
        if (!result.success) {
            console.error('Failed to load decks:', result.error);
            decksContainer.innerHTML = '<p class="text-red-400">Error loading decks. Please try again.</p>';
            return;
        }
        
        userDecks = result.decks || [];
        console.log('Decks loaded:', userDecks);
        
        // Filter out the "Owned Cards" deck from the main list
        const regularDecks = userDecks.filter(deck => deck.name !== "Owned Cards");
        console.log('Regular decks (excluding Owned Cards):', regularDecks);
        
        // Clear the container
        decksContainer.innerHTML = '';
        
        // Display decks or a message if none
        if (regularDecks.length === 0) {
            decksContainer.innerHTML = '<p class="text-blue-300 text-center">You have no decks yet. Create your first deck!</p>';
            return;
        }
        
        // Create a card for each deck
        regularDecks.forEach(deck => {
            // Add debugging to see what's in each deck object
            console.log('Processing deck:', deck);
            console.log('Deck ID:', deck.deck_id);
            console.log('Deck keys:', Object.keys(deck));
            
            const deckCard = document.createElement('div');
            deckCard.className = 'deck-card backdrop-blur-md bg-slate-900/40 border border-blue-500/30 rounded-lg p-4 cursor-pointer shimmer hover:border-blue-400/60 hover:bg-slate-800/60 transition-all relative';
            deckCard.innerHTML = `
                <div class="deck-content">
                    <h3 class="text-lg font-semibold text-blue-300">${deck.name}</h3>
                    <p class="text-gray-300 text-sm">Created: ${new Date(deck.created_at).toLocaleDateString()}</p>
                    <p class="text-gray-400 text-xs">ID: ${deck.deck_id || 'No ID found'}</p>
                </div>
                <div class="absolute top-2 right-2 flex gap-2">
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200" 
                            onclick="event.stopPropagation(); deleteDeck('${deck.deck_id}', '${deck.name}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            
            // Add hover effect to show delete button
            deckCard.addEventListener('mouseenter', () => {
                deckCard.classList.add('group');
                const deleteBtn = deckCard.querySelector('.delete-btn');
                deleteBtn.style.opacity = '1';
            });
            
            deckCard.addEventListener('mouseleave', () => {
                deckCard.classList.remove('group');
                const deleteBtn = deckCard.querySelector('.delete-btn');
                deleteBtn.style.opacity = '0';
            });
            
            // Add click event for opening deck (but not on delete button)
            deckCard.addEventListener('click', (e) => {
                // Check if the click was on the delete button or its children
                if (e.target.closest('.delete-btn')) {
                    return; // Don't open deck if delete button was clicked
                }
                
                console.log('Clicking deck with ID:', deck.deck_id);
                if (!deck.deck_id) {
                    alert('This deck has no ID and cannot be opened.');
                    return;
                }
                window.location.href = `Deck.html?id=${deck.deck_id}`;
            });
            
            decksContainer.appendChild(deckCard);
        });
    } catch (error) {
        console.error('Error in loadUserDecks:', error);
        decksContainer.innerHTML = '<p class="text-red-400">Error loading decks. Please try again.</p>';
    }
}

async function loadOwnedCards() {
    const result = await getUserDecks();
    if (!result.success) {
        alert("Could not load your decks.");
        return;
    }
    const ownedDeck = result.decks.find(deck => deck.name === "Owned Cards");
    if (!ownedDeck) {
        alert("Owned Cards deck not found!");
        return;
    }
    // Redirect to Ownedcards.html with the owned deck's ID
    window.location.href = `Ownedcards.html?id=${ownedDeck.deck_id}`;
}

async function createNewDeck() {
    const deckName = prompt('Enter a name for your new deck:');
    if (!deckName || deckName.trim() === '') return;
    
    // Prevent creating a deck with the reserved name "Owned Cards"
    if (deckName.trim() === "Owned Cards") {
        alert("'Owned Cards' is a reserved name. Please choose a different name for your deck.");
        return;
    }
    
    try {
        // Show loading state
        const decksContainer = document.getElementById('decks-container');
        decksContainer.innerHTML = '<div class="text-center"><p class="text-blue-300/50">Creating your deck...</p></div>';
        
        // Create the deck
        console.log('Creating new deck:', deckName);
        const result = await createDeck(deckName.trim());
        
        if (!result.success) {
            console.error('Failed to create deck:', JSON.stringify(result.error, null, 2));
            alert('Error creating deck. Please try again.');
            await loadUserDecks(); // Reload the current decks
            return;
        }
        
        console.log('Deck created successfully:', result.deck);
        alert(`Your "${deckName}" deck has been created!`);
        
        // Reload decks to show the new one
        await loadUserDecks();
    } catch (error) {
        console.error('Error in createNewDeck:', error);
        alert('Error creating deck. Please try again.');
        await loadUserDecks(); // Reload the current decks
    }
}

async function deleteDeck(deckId, deckName) {
    // Prevent deletion of the "Owned Cards" deck
    if (deckName === "Owned Cards") {
        alert("The 'Owned Cards' deck cannot be deleted. This is a special system deck.");
        return;
    }
    
    // Add debugging to see what we're actually trying to delete
    console.log('=== DELETE DECK DEBUG ===');
    console.log('UI shows deck name:', deckName);
    console.log('UI shows deck ID:', deckId);
    console.log('Type of deck ID:', typeof deckId);
    console.log('========================');
    
    // Confirm deletion
    const confirmed = confirm(`Are you sure you want to delete "${deckName}"?\n\nThis action cannot be undone and will delete all cards in this deck.`);
    
    if (!confirmed) {
        return;
    }
    
    try {
        // Show loading state
        const decksContainer = document.getElementById('decks-container');
        decksContainer.innerHTML = '<div class="text-center"><p class="text-blue-300/50">Deleting deck...</p></div>';
        
        // Delete the deck
        console.log('Deleting deck:', deckName, 'with ID:', deckId);
        const result = await deleteDeck(deckId);
        
        if (!result.success) {
            console.error('Failed to delete deck:', JSON.stringify(result.error, null, 2));
            alert('Error deleting deck. Please try again.');
            await loadUserDecks(); // Reload the current decks
            return;
        }
        
        console.log('Deck deleted successfully');
        alert(`"${deckName}" has been deleted successfully.`);
        
        // Reload decks to update the display
        await loadUserDecks();
    } catch (error) {
        console.error('Error in deleteDeck:', error);
        alert('Error deleting deck. Please try again.');
        await loadUserDecks(); // Reload the current decks
    }
}
</script>
</body>
</html>